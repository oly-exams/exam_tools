# Exam Tools

## Dependencies
Base dependencies
* Python 3.8
* Django 4.1.x
* django-crispy-forms
* mkdocs (for building the docs)
* bower

To compile exams
* XeLaTeX
* Fonts, TODO provide list of required fonts
* CairoSVG (figure convert)
* pyPDF2 (manipulation of PDF)
* Barcode (generate barcodes)
* pandoc (to generate odt exports)

### Example Ubuntu packages
On Ubuntu (currently 20.04 LTS), install these packages using ```apt-get```:
```
git
python-dev
python-psycopg2 # only if using PostgreSQL DB
python-virtualenv
python-pip
mercurial
libffi-dev
libzbar-dev
python-cairosvg
texlive
texlive-xetex
texlive-lang-cjk
texlive-lang-greek
fonts-roboto
ttf-mscorefonts-installer # this requires the multiverse packages in Ubuntu!!
fonts-liberation
pandoc
```

Then using ```pip```:
```bash
pip install -r requirements.txt
```
For development, also install:
```
pip install -r requirements_dev.txt```

### Install bower

```bash
curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
sudo apt-get install -y nodejs

sudo npm install -g bower
```

## Install
1. Create exam_tools/settings.py, for a simple installation simply copy exam_tools/settings_example.py
```bash
cp exam_tools/settings_example.py exam_tools/settings.py
```

1. If using a virtualenv, make sure it is active

1. Install dependencies using bower, by running at the project root
```bash
cd bower && bower install
```

1. Initialize DB
```bash
python manage.py migrate
```

1. Fill with initial data
```bash
./scripts/loaddata_from.sh <fixtures>
```

1. (optional) Fill with test data
```bash
./scripts/loaddata_from.sh <test_fixtures>
```

## Running
For the local server, simply execute
```bash
python manage.py runserver
```
For the compilation workers, you need to install rabbitmq and then run it by executing
```bash
rabbitmq-server
```
and for the compilation workers
```bash
celery -A exam_tools worker -E --concurrency=1
```

## Building the docs
For development it is suggested to serve the docs locally
```bash
mkdocs serve -a localhost:8001
```

For building the static docs
```bash
mkdocs build
```

For building docs with custom event target
```bash
python ./scripts/mkdocs_custom.py <name_of_the_event_target>
```

And for locally serving them
```bash
python ./scripts/mkdocs_custom.py -s <name_of_the_event_target>
```
or
```bash
python ./scripts/mkdocs_custom.py -s -a localhost:8080 <name_of_the_event_target>
```

## Docker images
To build the docker images:

```bash
docker build -f docker/Dockerfile.master .
```

## Development with Docker

The development with Docker requires the following folder structure:

```
...
 |-- data_store    (autogenerated eventually, stores the data)
 |-- exam_tools    (this repo)
 `-- docker_deploy (oly-exams/docker_deploy, private repo)

```

1. Launch the docker environment

    ```bash
    docker_deploy/docker/a-dev-compose.sh up
    ```

More information can be found in the docker_deploy repo.

## Using Precommit Hooks
Developers can use the precommit hooks to automatically format the code and get feedback. Install all dev dependencies
```bash
pip install -r requirements_dev.txt
```
followed by:

```bash
pre-commit install
```

Now the precommit hooks will run before every commit, and check the files that where modified. You can also run the hooks manually:

```bash
pre-commit run
pre-commit run --all-files
```


## Testing with Cypress and Django

### Django

Simply run
```bash
python manage.py test
```

### Cypress
The Cypress tests will automatically run in the CI. If you need to run tests locally, set it up as follows.
1. Use `settings_testing.py`, i.e.
```bash
cp exam_tools/settings_testing.py exam_tools/settings.py
```
2. Adjust any settings, if needed. Make sure not to change the db-settings, however. Cypress will copy the db to (re)initialize, thus the location of the SQLite db needs to be the one set in `settings_testing.py`.

3. Start the dev servers
```bash
../docker_deploy/docker/dev_compose.sh up
```

4. Run
```bash
python ipho_data/cypress_initial_data.py
```
inside the django server container to create the initial dataset. This needs to be done before each test, as cypress will override this. Alternatively, you can comment out `cy.exec()` in `e2e/cypress/support/commands.js` in `beforeAllDBInit` and manually create `database-initial` once:
```bash
cp database.s3db database-initial.s3db
```
(where `database.s3db` is created by `cypress_initial_data.py`)
5. Start the cypress container with
```bash
../docker_deploy/docker/cypress_xforward_bash.sh
```
This will open bash inside the cypress container.
Then you can:
* Run the tests using `cypress run`. If you only want to run one file you can use `cypress run --spec path/to/file`.
* Start the cypress test runner with `cypress open`. This will need X-forwarding to your OS, so you might to install some client (i.e. XMing on Windows).

You can find more about writing tests in the [Cypress readme](e2e/README.md)
