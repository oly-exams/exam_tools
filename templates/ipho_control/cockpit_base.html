{% extends "ipho_control/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra-head %}
<style>
  .label-setting-active {
    color:black;
    background-color: #ffbf00;
  }
  .label-setting-inactive {
    color:black;
    background-color: rgb(127, 158, 251);
  }
  .label{
    cursor: default;
  }
</style>
{% endblock %}

{% block pageheader %}<h1 style="margin-top: 10px;">{{ h1 }}</h1>{% endblock %}

{% block page-content %}
{# modal for switching the state #}
<div class="modal fade" id="switch-state-modal" tabindex="-1" aria-labelledby="modalLabel">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> Title </h4>
      </div>
      <div class="modal-body">
        Body
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Abort</button>
        <button id="switch-state-submit" data-href="" class="btn btn-primary disabled">Switch</button>
      </div>
      
    </div>
  </div>
</div>

{# modal showing the exam history #}
<div class="modal fade" id="history-modal" tabindex="-1" aria-labelledby="modalLabel">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> Title </h4>
      </div>
      <div class="modal-body">
        Body
      </div>
    </div>
  </div>
</div>

{# modal for deleting the state #}
<div class="modal fade" id="delete-modal" tabindex="-1" aria-labelledby="modalLabel">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> Title </h4>
      </div>
      <div class="modal-body">
        Body
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Abort</button>
        <button id="delete-state-submit" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

    <div id="alerts-container">
        {% for alert in alerts %}
        {{ alert|safe }}
        {% endfor %}
    </div>
    <ul class="nav nav-tabs">
      {% for exam in exam_list %}
      <li role="presentation" class="{% if exam.active_tab %}active{% endif %}">
        <a style="font-size: 18px;" href="{% if not exam.active_tab %}{% url 'control:cockpit-id' exam.exam.pk%}{% endif %}">
          <span>
            {{ exam.exam.name }}
          </span>
          {% if exam.state and not exam.state.undef %}
          <span class="label label-default">
            {{ exam.state.name }}
          </span>
          {% endif %}
        </a>
      </li>
      {% endfor %}
    </ul>

    <div class="row">
      <div class="col-md-6">
        <h3>Current state:</h3>
        <div class="panel panel-primary">
          <div style="font-size: 16px;" class="panel-heading">
            <div style="font-size: 20px;">
              {{ active_exam.state.name }}
            </div>
            {% for name, setting in active_exam.state.exam_settings.items %}
              {% if setting is True %}
                <span class="label label-setting-active" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: <span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>
              {% elif setting is False %}  
                <span class="label label-setting-inactive" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span>
              {% else %}
                <span class="label label-default" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: {{ setting }}</span>
              {% endif %}
            {% endfor %}
          </div>
          <div class="panel-body">
            
            <p>
              {{ active_exam.state.description }}
            </p>
            
          </div>
        </div>
        {% if question_settings %}
          <h3>Question settings:</h3>
          {% include "ipho_control/question_settings.html" %}
        {% endif %}
      </div>
      <div class="col-md-6" id="state-list">
        <h3>Available states: 
        {% if superuser %}
          <a role="button" class="btn btn-default" target="_blank" href="{% url 'control:add-state' %}">
            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> New State
          </a>
        {% endif %}
        <button type="button" class="btn btn-default" data-toggle="modal" data-target="#history-modal" data-modal-url="{% url 'control:exam-history' active_exam.exam.pk %}" >
          Show History
          <span class="glyphicon glyphicon-time" aria-hidden="true"></span> 
        </button>
        </h3>
        <div style="overflow-y:auto; max-height: 55vh;">
          {% for state in states %}
          {% with checks=checks_list|lookup:state.pk %}
          <div class="panel panel-info state-panel {% if state.is_current_state %}current-state{% endif %}">
            <div class="panel-heading" style="display: flex; justify-content: space-between;">
              <div>
                <div style="font-size: 20px;">
                  {{ state.name }}
                </div>
                {% for name, setting in state.exam_settings.items %}
                  {% if setting is True %}
                    <span class="label label-setting-active" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: <span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>
                  {% elif setting is False %}  
                    <span class="label label-setting-inactive" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span>
                  {% else %}
                    <span class="label label-default" data-toggle="tooltip" title="{{ help_texts_settings|lookup:name }}">{{ name }}: {{ setting }}</span>
                  {% endif %}
                {% endfor %}
              </div>
              {% if superuser %}
                <div>
                  <a role="button" class="btn btn-default" target="_blank" href="{% url 'control:edit-state' state.pk %}">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
                  </a>
                  <button type="button" class="btn btn-default" data-toggle="modal" data-target="#delete-modal" data-href="{% url 'control:delete-state' state.pk %}">
                    <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
                  </button>
                </div>
              {% endif %}
            </div>
            <div class="panel-body">
              <p>
                {{ state.description }}
              </p>
            </div>
            <div class="panel-footer" style="display: flex; flex-wrap: nowrap; justify-content: space-between; font-size: 20px;">
                <div>
                  {% for check in checks.warnings %}
                    {% if check.passed %}
                      <span class="label label-success" data-toggle="popover" data-content="{{ checks.help_texts|lookup:check.name }}">{{ check.pretty }}: <span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>
                    {% else %}
                      <span class="label label-warning" data-toggle="popover" data-html="true" title="{{ checks.help_texts|lookup:check.name }}" data-content="{{ check.message }}">{{ check.pretty }}: <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span>
                    {% endif %}
                  {% endfor %}
                  {% for check in checks.errors %}
                    {% if check.passed %}
                      <span class="label label-success" data-toggle="popover" data-content="{{ checks.help_texts|lookup:check.name }}">{{ check.pretty }}: <span class="glyphicon glyphicon-ok" aria-hidden="true"></span></span>
                    {% else %}
                      <span class="label label-danger" data-toggle="popover" data-html="true" title="{{ checks.help_texts|lookup:check.name }}" data-content="{{ check.message }}">{{ check.pretty }}: <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span>
                    {% endif %}
                  {% endfor %}
                </div>  
                {% if state.is_applicable and not state.is_current_state %}
                  <span>
                    <button type="button" class="btn btn-warning btn-lg pull-right" data-toggle="modal" data-target="#switch-state-modal" data-modal-url="{% url 'control:switch-state' active_exam.exam.pk state.pk %}">Switch state</button>
                  </span>
                  {% elif state.is_current_state %}
                  <span data-toggle="tooltip" title="Cannot switch to current state." >
                    <button type="button" class="btn btn-primary btn-lg pull-right disabled" >Current state</button>
                  </span>
                {% else %}
                  <span data-toggle="tooltip" title="Checks failed. Cannot switch to this state." >
                    <button type="button" class="btn btn-warning btn-lg pull-right disabled" >Cannot switch state</button>
                  </span>
                {% endif %}
                </div>
          </div>
          {% endwith %}
          {% endfor %}
      </div>
      </div>
    </div>
    

{% endblock %}

{% block extra-script %}
<script>
  $('document').ready(function(){

    $('[data-toggle="tooltip"]').tooltip({
      delay: { "show": 200, "hide": 10 }
    }); 
    $('[data-toggle="popover"]').popover({
      delay: { "show": 200, "hide": 10 },
      trigger: "hover"
    }); 
    if($( "#state-list").find(".current-state").length){
      $( "#state-list").find(".current-state")[0].scrollIntoView();
    }
    
  })
  $('document').ready(function(){
    
    

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }
    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    $('#switch-state-modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var href = button.data('modal-url');
      var modal = $(this);

      modal.find('.modal-title').html('<i class="fa fa-spinner fa-pulse"></i> Loading...');
      modal.find('.modal-body').html('');
      $('#switch-state-submit').addClass('disabled');
      $('#switch-state-submit').data('href', '');
      $.ajax({
            url: href,
            dataType: 'json',
            success: function(data) {
              if(data['success']){
                modal.find('.modal-title').html(data['title']);
                modal.find('.modal-body').html(data['body']);
                $('#switch-state-submit').removeClass('disabled');
                $('#switch-state-submit').data('href', href);
                $('[data-toggle="tooltip"]').tooltip({
                  delay: { "show": 200, "hide": 10 }
                }); 
              }else{
                modal.find('.modal-title').text("Error");
                modal.find('.modal-body').html('<div class="alert alert-warning" role="alert">'+data["error"]+'</div>')
              }
                
            },
        });
    });

    $('#switch-state-submit').on('click', function (event) {
      event.preventDefault();
      var button = $(this);
      var href = button.data('href');
      var modal = $('#switch-state-modal');

      modal.find('.modal-title').html('<i class="fa fa-spinner fa-pulse"></i> Loading...');
      modal.find('.modal-body').html('');
      $('#switch-state-submit').addClass('disabled');
      $.ajax({
            url: href,
            dataType: 'json',
            method: 'post',
            success: function(data) {
              if(data['success']){
                window.location.href = '{% url "control:cockpit-changed-state" active_exam.exam.pk %}';
              }else{
                modal.find('.modal-title').text("Error");
                modal.find('.modal-body').html('<div class="alert alert-warning" role="alert">'+data["error"]+'</div>')
              }
                
            },
        });
    });
    
    $('#history-modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var href = button.data('modal-url');
      var modal = $(this);

      modal.find('.modal-title').html('<i class="fa fa-spinner fa-pulse"></i> Loading...');
      modal.find('.modal-body').html('');
      $.ajax({
            url: href,
            dataType: 'json',
            success: function(data) {
              if(data['success']){
                modal.find('.modal-title').html(data['title']);
                modal.find('.modal-body').html(data['body']);
                $('[data-toggle="tooltip"]').tooltip({
                  delay: { "show": 200, "hide": 10 }
                }); 
                $("time[data-format]").each(function () {
                  var el = $(this);
                  var dt = moment(el.attr("datetime"));
                  el.text(dt.format(el.data("format")));
                });
              }else{
                modal.find('.modal-title').text("Error");
                modal.find('.modal-body').html('<div class="alert alert-warning" role="alert">'+data["error"]+'</div>')
              }
                
            },
        });
    });

    $('#delete-modal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var href = button.data('href');
      var modal = $(this);

      modal.find('.modal-title').html('<i class="fa fa-spinner fa-pulse"></i> Loading...');
      modal.find('.modal-body').html('');

      $('#delete-state-submit').addClass('disabled');
      $('#delete-state-submit').data('href', '');
      $.ajax({
            url: href,
            dataType: 'json',
            success: function(data) {
              if(data['success']){
                modal.find('.modal-title').html(data['title']);
                modal.find('.modal-body').html(data['body']);
                $('#delete-state-submit').removeClass('disabled');
                $('#delete-state-submit').data('href', href);
              }else{
                modal.find('.modal-title').text("Error");
                modal.find('.modal-body').html('<div class="alert alert-warning" role="alert">'+data["error"]+'</div>')
              }
                
            },
        });
    });

    $('#delete-state-submit').on('click', function (event) {
      event.preventDefault();
      var button = $(this);
      var href = button.data('href');
      var modal = $('#delete-modal');

      modal.find('.modal-title').html('<i class="fa fa-spinner fa-pulse"></i> Loading...');
      modal.find('.modal-body').html('');
      $('#delete-state-submit').addClass('disabled');
      $.ajax({
            url: href,
            dataType: 'json',
            method: 'post',
            success: function(data) {
              if(data['success']){
                window.location.href = '{% url "control:cockpit-deleted-state" active_exam.exam.pk %}';
              }else{
                modal.find('.modal-title').text("Error");
                modal.find('.modal-body').html('<div class="alert alert-warning" role="alert">'+data["error"]+'</div>')
              }
                
            },
        });
    });


  });
</script>
{% endblock %}