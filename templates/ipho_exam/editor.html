{% extends "base.html" %}
{% load static %}
{% load editor_extras %}

{% block extra-head %}
<link href="{% static "mathquill/mathquill.css" %}" rel="stylesheet">

<style>
span.dropdown {
    display: inline-block;
}
.title-dropdown .btn {
    padding: 0px 28px;
    padding: 0;
    font-size: 28px;
    line-height: normal;
    -webkit-border-radius: 8px;
       -moz-border-radius: 8px;
            border-radius: 8px;
}
.title-dropdown .dropdown-menu {
    font-size: 20px;
}

.translation-field-nested .row {
    padding-left: 1em;
    padding-right: 1em;
}

.cke_textarea_inline {
/*    border:1px #000 solid;*/
}

body { margin-bottom: 70px; }
</style>

{% endblock %}


{% block content %}
<div class="container">

{% if warning %}
    <div class="alert alert-warning alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <strong>Warning:</strong> {{ warning }}
    </div>
{% endif %}

<div class="modal fade" id="ipho_exam-modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title">Do you want to save changes before leaving?</h3>
      </div>
      <div class="modal-body">
        <p>Your changes will be lost if you don't save them.</p>
      </div>
      <div class="modal-footer">
          <div class="pull-left">
              <button type="button" class="btn btn-default" data-action="discard">Discard changes</button>
          </div>
          <div class="pull-right">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" data-action="save">Save changes</button>
          </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="page-header">
    <div class="dropdown pull-right">
      <a class="btn btn-primary btn-lg dropdown-toggle" type="button" data-toggle="dropdown">
{% if exam %}
        {{ exam.name }}
{% else %}
        Select exam
{% endif %}
        <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
    {% for ex in exam_list %}
        <li {% if exam == ex %} class="active" {% endif %}><a href="{% url 'exam:editor-exam' exam_id=ex.pk %}">{{ ex.name }}</a></li>
    {% endfor %}
      </ul>
    </div>
  <h1>Exam editor</h1>
</div>

<!-- <div class="page-header">
  <h2>Exam editor :

  <span class="title-dropdown dropdown">
    <a class="btn btn-link btn-lg dropdown-toggle" type="button" data-toggle="dropdown">
      Theory Exam
      <span class="caret"></span>
    </a>
    <ul class="dropdown-menu">
      <li><a href="#">Demo Exam</a></li>
      <li class="active"><a href="#">Theory Exam</a></li>
      <li><a href="#">Experimental Exam</a></li>
    </ul>
  </span>
  </h2>
</div> -->

<ul class="nav nav-tabs">
    {% for q in exam.question_set.all %}
        <li {% if question == q %} class="active" {% endif %}><a href="{% url 'exam:editor-question' exam_id=exam.pk question_id=q.pk %}">{{ q.name }}</a></li>
    {% endfor %}
</ul>

{% if question %}
    
    <form method="post" action="" charset="utf8" id="ipho_exam-form">
        {% csrf_token %}
        <h3>{{ question.name }} <small><i class="fa fa-fw fa-lg fa-unlock"></i></small></h3>
    
        <div class="row">
            <div class="col-xs-5">
                <h4>Original: 
                <span class="dropdown">
                  <a class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                    {{ orig_lang.name }}
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                      {% if trans_lang %}
                          {% for l in all_lang %}
                              <li {% if orig_lang == l %} class="active" {% endif %}><a href="{% url 'exam:editor-lang' exam_id=exam.pk question_id=question.pk orig_id=l.pk lang_id=trans_lang.pk %}">{{ l.name }}</a></li>
                          {% endfor %}
                      {% else %}
                          {% for l in all_lang %}
                              <li {% if orig_lang == l %} class="active" {% endif %}><a href="{% url 'exam:editor-orig' exam_id=exam.pk question_id=question.pk orig_id=l.pk %}">{{ l.name }}</a></li>
                          {% endfor %}
                      {% endif %}
                  </ul>
                </span>
                </h4>
            </div>
            
            <div class="col-sm-2 text-center">
            </div>
            
            <div class="col-xs-5">
                <h4>Translate to:
                <span class="dropdown">
                  <a class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown">
                    {% if trans_lang %}
                        {{ trans_lang.name }}
                    {% else %}
                        Select language
                    {% endif %}
                    <span class="caret"></span>
                  </a>
                  <ul class="dropdown-menu">
                      {% for l in own_lang %}
                          <li {% if trans_lang == l %} class="active" {% endif %}><a href="{% url 'exam:editor-lang' exam_id=exam.pk question_id=question.pk orig_id=orig_lang.pk lang_id=l.pk %}">{{ l.name }}</a></li>
                      {% endfor %}
                  </ul>
                </span>
                </h4>
            </div>
        </div>
        
        
        <div class="translation-field-container">
        {% with content_set as fields_set %}
            {% include 'ipho_exam/editor_field.html' %}
        {% endwith %}
        </div>
        
        {% if form %}
        <div class="navbar navbar-default navbar-fixed-bottom">
          <div class="container">
            <div class="navbar-right">
                <button type="button" class="btn btn-success navbar-btn"><i class="fa fa-fw fa-file-pdf-o"></i> View PDF</button>
                <button type="button" class="btn btn-default navbar-btn"><i class="fa fa-fw fa-unlock"></i> Lock</button>
                <button type="submit" class="btn btn-primary navbar-btn"><span class="glyphicon glyphicon-floppy-disk"></span> Save</button>
            </div>
    
          </div>
        </div>
        {% endif %}
    </form>
{% endif %}
</div> <!-- /container -->

{% endblock %}



{% block extra-script %}
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            showMathMenu: false,
        });
    </script>
    <script src="{% static "MathJax/MathJax.js" %}?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="{% static "ckeditor/ckeditor.js" %}"></script>
    <script src="{% static "ckeditor/adapters/jquery.js" %}"></script>
    
    <script src="{% static "jquery-dirtyforms/jquery.dirtyforms.js" %}"></script>
    <script src="{% static "jquery-dirtyforms/helpers/ckeditor.js" %}"></script>
    
    <script>
        CKEDITOR.config.toolbar = [
                [ 'Bold', 'Italic', 'Underline', '-', 'Mathjax', '-', 'BidiLtr', 'BidiRtl']
            ];
        CKEDITOR.config.forcePasteAsPlainText = true;
        CKEDITOR.config.resize_enabled = false;
        CKEDITOR.config.extraPlugins = 'autogrow,widget,bidi,mathjax';
        CKEDITOR.config.removePlugins = 'elementspath,contextmenu,tabletools,liststyle';
        // CKEDITOR.config.extraAllowedContent = 'span(math-tex)';
        CKEDITOR.config.width = '100%';
        CKEDITOR.config.autoGrow_onStartup = true;
        CKEDITOR.config.autoGrow_minHeight = 0;
        CKEDITOR.config.autoGrow_bottomSpace = 10;
        CKEDITOR.config.entities = false;
        CKEDITOR.config.htmlEncodeOutput = false;
        CKEDITOR.config.basicEntities = false;
        CKEDITOR.config.entities_latin = false;
        CKEDITOR.config.entities_greek = false;
        CKEDITOR.config.disableNativeSpellChecker = false;
        CKEDITOR.config.autoParagraph = false;
        CKEDITOR.config.mathJaxLib = '{% static "MathJax/MathJax.js" %}?config=TeX-AMS-MML_HTMLorMML';
        
        
        all_editors = new Array();
        
        function content2math() {
            // convert equations for mathquill
            // var newtext = $(this).html().replace(/\$(.+?)\$/g, '<img class="mathImg" title="$1" src="http://latex.codecogs.com/svg.latex?$1" />');
            // var newtext = $(this).html().replace(/\$(.+?)\$/g, '<span class="mathquill-embedded-latex" data-cke-survive=1>$1</span>');
            
            // convert equations for mathjax
            // TODO: remove once the tests have been converted to \( \) format. $ $ is too dangerous, since it might delimit two prices in dollars.
            var newtext = $(this).html().replace(/\$(.+?)\$/g, '<span class="math-tex">\\($1\\)</span>');
            $(this).html(newtext);
            MathJax.Hub.Queue(["Typeset",MathJax.Hub, this]);
        }
        
        $(function(){
            
            $(".translate-original").each(content2math);
            $(".translate-foreign").each(content2math);
            
            $(".translate-copy-button").click(function( event ) {
                field_id =  $(this).attr('id').replace('-copy', '');
                orig = '#' + $(this).attr('id').replace('-copy', '-original');
                if (field_id in all_editors)
                    all_editors[field_id].setData($(orig).data('original-text'));
                else
                    $('#'+field_id+'-translate input[type="text"]').val($(orig).data('original-text'));
                event.preventDefault();
            });
            
            
            $('.translate-foreign textarea').each(function() {
                myid = $(this).parent().attr('id').replace('-translate', '');
                // all_editors[myid] = CKEDITOR.replace(this);
                all_editors[myid] = $(this).ckeditor().ckeditorGet();
            })
            
            
            $.DirtyForms.dialog = {
                            refire : function(content, ev){
                                $('#ipho_exam-modal').modal('show');
                            },
                            fire : function(message, title){
                                $('#ipho_exam-modal .modal-title').html(title);
                                $('#ipho_exam-modal .modal-body').html(message);
                                $('#ipho_exam-modal').modal('show');
                                
                            },
                            bind : function(){
                                // $('.modal .close, .modal .secondary').click(decidingCancel);
                                $(".modal [data-action='save']").click(function() {alert('want to save!');});
                                $(".modal [data-action='discard']").click(decidingContinue);
                                $(document).bind('decidingcancelled.dirtyforms', function(){
                                    $('#ipho_exam-modal').modal('hide');
                                });
                            },
                            stash : function(){
                                var fb = $('.modal');
                                return ($.trim(fb.html()) == '' || fb.css('display') != 'block') ?
                                   false :
                                   $('.modal .modal-body').clone(true);
                            },
                            selector : '.modal .modal-body'
                        };
            $.DirtyForms.title = "Do you want to save changes before leaving?"
            $.DirtyForms.message = "Your changes will be lost if you don't save them."
            $('#ipho_exam-form').dirtyForms();
            
        });
        
    </script>
    
{% endblock %}
