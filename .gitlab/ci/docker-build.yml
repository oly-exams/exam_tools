build:docker-images:
  stage: build
  interruptible: false

  image: docker

  variables:
    DOCKER_CACHE: "no"
    DOCKER_LAYER_CACHE: "no"
    DOCKER_BUILDKIT: "1"

    # technical git variables
    GIT_DEPTH: 1 # (default=50) we need the previous commit for pre-commit
    REGISTRY: "registry.gitlab.com/oly-exams/exam_tools"

  before_script: |
    docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY

  script: |
    REGISTRY=${REGISTRY} TAG=${CI_COMMIT_SHA}-untested docker buildx bake --push -f docker/bake.yml

post-test:docker-images:
  stage: post-test
  interruptible: false

  image: docker

  variables:
    # technical git variables
    GIT_DEPTH: 1 # (default=50) we need the previous commit for pre-commit
    REGISTRY: "registry.gitlab.com/oly-exams/exam_tools"

  before_script: |
    docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY

  script: |

    for stage_name in 'django-server' 'celery-worker' 'nginx-with-static'; do
      docker pull ${REGISTRY}/${stage_name}:${CI_COMMIT_SHA}-untested

      docker tag ${REGISTRY}/${stage_name}:${CI_COMMIT_SHA}-untested ${REGISTRY}/${stage_name}:${CI_COMMIT_SHA}
      docker push ${REGISTRY}/${stage_name}:${CI_COMMIT_SHA}

      docker tag ${REGISTRY}/${stage_name}:${CI_COMMIT_SHA}-untested ${REGISTRY}/${stage_name}:${CI_COMMIT_REF_SLUG}
      docker push ${REGISTRY}/${stage_name}:${CI_COMMIT_REF_SLUG}
    done
