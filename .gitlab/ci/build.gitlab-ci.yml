.build:build_cached_push:
    stage: build
    variables:
        BUILD_ARG: ""
        IMG_TAG: $CI_COMMIT_BRANCH
    script:
        # I cannot build this variable in gitlab, since they dont allow nested $
        - IMG="$PROJ_REG/$IMG_NAME:$IMG_TAG"
        # this is the recommended way to reuse layers
        # (https://docs.gitlab.com/ee/user/packages/container_registry/index.html#using-a-docker-in-docker-image-from-your-container-registry)
        - docker pull $IMG || true
        - docker build --pull --cache-from $IMG --build-arg=$BUILD_ARG -f docker/images/Dockerfile.$IMG_NAME -t $IMG .
        - docker push $IMG

build:pre-commit:
    extends: .build:build_cached_push
    variables:
        IMG_NAME: pre-commit
    rules:
        - changes:
            - docker/images/Dockerfile.pre-commit
            - .pre-commit-config.yaml

build:server:
    extends: .build:build_cached_push
    variables:
        IMG_NAME: server
    rules:
        - changes:
            - docker/images/Dockerfile.server

build:testing_cypress:
    extends: .build:build_cached_push
    variables:
        IMG_NAME: testing_cypress
        BUILD_ARG: SERVER_IMG=$PROJ_REG/server:$IMG_TAG
    rules:
        - changes:
            - docker/images/Dockerfile.testing_cypress

build:echo:
    stage: build
    variables:
        IMG_NAME: echo
    script:
        - echo $IMG_NAME
